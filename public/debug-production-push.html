<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Push Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Production Push Notification Debug</h1>
    
    <div class="test-section">
        <h3>Step 1: Environment Check</h3>
        <button onclick="checkEnvironment()">Check Production Environment</button>
        <div id="envResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 2: Test Database Connection</h3>
        <button onclick="testDatabase()">Test Database</button>
        <div id="dbResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 3: Test Subscription Save</h3>
        <button onclick="testSubscriptionSave()">Test Save Subscription</button>
        <div id="saveResult"></div>
    </div>

    <div class="test-section">
        <h3>Step 4: Actual Push Registration Test</h3>
        <button onclick="testActualPush()">Test Real Push Subscription</button>
        <div id="pushResult"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        
        async function checkEnvironment() {
            const result = document.getElementById('envResult');
            try {
                const response = await fetch(`${API_BASE}/api/web-push/debug-production-issue`);
                const data = await response.json();
                
                result.innerHTML = `
                    <h4 class="${data.tests.environment_vars.has_supabase_url ? 'success' : 'error'}">
                        Environment Variables
                    </h4>
                    <pre>${JSON.stringify(data.tests.environment_vars, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testDatabase() {
            const result = document.getElementById('dbResult');
            try {
                const response = await fetch(`${API_BASE}/api/web-push/debug-production-issue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test_subscription: true })
                });
                const data = await response.json();
                
                const dbTest = data.tests.supabase_connection;
                const tableTest = data.tests.table_structure;
                const saveTest = data.tests.test_subscription_save;
                
                result.innerHTML = `
                    <h4 class="${dbTest.success ? 'success' : 'error'}">Database Connection</h4>
                    <pre>${JSON.stringify(dbTest, null, 2)}</pre>
                    
                    <h4 class="${tableTest.success ? 'success' : 'error'}">Table Structure</h4>
                    <pre>${JSON.stringify(tableTest, null, 2)}</pre>
                    
                    <h4 class="${saveTest.success ? 'success' : 'error'}">Test Subscription Save</h4>
                    <pre>${JSON.stringify(saveTest, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testSubscriptionSave() {
            const result = document.getElementById('saveResult');
            try {
                // Create a fake subscription object
                const fakeSubscription = {
                    endpoint: 'https://test-endpoint-' + Date.now() + '.example.com/test',
                    keys: {
                        p256dh: 'fake-p256dh-key-' + Math.random().toString(36).substring(7),
                        auth: 'fake-auth-key-' + Math.random().toString(36).substring(7)
                    }
                };

                const response = await fetch(`${API_BASE}/api/web-push/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription: fakeSubscription })
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `
                        <div class="success">‚úÖ Subscription saved successfully!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">‚ùå Failed to save subscription</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testActualPush() {
            const result = document.getElementById('pushResult');
            
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                result.innerHTML = '<div class="error">‚ùå Push notifications not supported</div>';
                return;
            }

            try {
                // Register service worker
                result.innerHTML = '<div class="info">üîÑ Registering service worker...</div>';
                
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                await navigator.serviceWorker.ready;

                result.innerHTML += '<div class="success">‚úÖ Service worker registered</div>';

                // Request notification permission
                result.innerHTML += '<div class="info">üîÑ Requesting notification permission...</div>';
                
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    result.innerHTML += '<div class="error">‚ùå Notification permission denied</div>';
                    return;
                }

                result.innerHTML += '<div class="success">‚úÖ Notification permission granted</div>';

                // Subscribe to push notifications
                result.innerHTML += '<div class="info">üîÑ Subscribing to push notifications...</div>';
                
                const vapidPublicKey = 'BCwd-s7rWYpckccB13n6oQANhYbo_Q2IWZTeMqZXvOuUJfeEyWhY8RWPF3C52ALdUPk7lunz-y9RO7SBL0pAKxY';
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: vapidPublicKey
                });

                result.innerHTML += '<div class="success">‚úÖ Push subscription created</div>';
                result.innerHTML += `<pre>Subscription: ${JSON.stringify(subscription.toJSON(), null, 2)}</pre>`;

                // Save subscription to server
                result.innerHTML += '<div class="info">üîÑ Saving subscription to server...</div>';
                
                const saveResponse = await fetch(`${API_BASE}/api/web-push/subscribe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });

                const saveData = await saveResponse.json();
                
                if (saveResponse.ok) {
                    result.innerHTML += '<div class="success">‚úÖ Subscription saved to server!</div>';
                    result.innerHTML += `<pre>Server response: ${JSON.stringify(saveData, null, 2)}</pre>`;
                } else {
                    result.innerHTML += '<div class="error">‚ùå Failed to save subscription to server</div>';
                    result.innerHTML += `<pre>Server error: ${JSON.stringify(saveData, null, 2)}</pre>`;
                }

            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
                result.innerHTML += `<pre>Stack trace: ${error.stack}</pre>`;
            }
        }
    </script>
</body>
</html> 